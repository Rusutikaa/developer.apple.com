<!DOCTYPE html><html lang="en" data-reactroot=""><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"><title>Uploading Streams of Data | Apple Developer Documentation</title><!-- link href="https://www.apple.com/wss/fonts?families=SF+Pro,v1|SF+Mono,v1|SF+Pro+Icons,v1" media="all" rel="stylesheet" type="text/css"/ --><meta content="width=device-width, initial-scale=1 viewport-fit=cover" name="viewport"/><meta data-pid="492525"/><link href="../../../documentation/assets/application-e5bb1544.css" media="all" rel="stylesheet" type="text/css"/><noscript><link href="../../../documentation/assets/nojs-c6be9131.css" media="all" rel="stylesheet" type="text/css"/></noscript><link rel="mask-icon" href="../../../documentation/assets/apple-logo.svg" color="#000"/><link rel="shortcut icon" href="../../../documentation/assets/favicon.ico"/><script src="../../../documentation/assets/shared-b7676010.js"></script></head><body><div id="app"><div><a href="#main" id="skip-localnav" class="showonfocus hidden">Skip Navigation</a><aside id="ac-gn-segmentbar" class="ac-gn-segmentbar" lang="en-US" dir="ltr"></aside><input type="checkbox" id="ac-gn-menustate" class="ac-gn-menustate"/><nav id="ac-globalnav" class="no-js" role="navigation" aria-label="Global" data-hires="false" data-analytics-region="global nav" lang="en-US" dir="ltr" data-store-locale="us" data-store-api="/[storefront]/shop/bag/status" data-search-locale="en_US" data-search-api="/search-services/suggestions/">
      <div class="ac-gn-content">
        <ul class="ac-gn-header">
          <li class="ac-gn-item ac-gn-menuicon">
            <label class="ac-gn-menuicon-label" for="ac-gn-menustate" aria-hidden="true">
              <span class="ac-gn-menuicon-bread ac-gn-menuicon-bread-top">
                <span class="ac-gn-menuicon-bread-crust ac-gn-menuicon-bread-crust-top"></span>
              </span>
              <span class="ac-gn-menuicon-bread ac-gn-menuicon-bread-bottom">
                <span class="ac-gn-menuicon-bread-crust ac-gn-menuicon-bread-crust-bottom"></span>
              </span>
            </label>
            <a href="#ac-gn-menustate" role="button" class="ac-gn-menuanchor ac-gn-menuanchor-open" id="ac-gn-menuanchor-open">
              <span class="ac-gn-menuanchor-label">Global Nav Open Menu</span>
            </a>
            <a href="#" role="button" class="ac-gn-menuanchor ac-gn-menuanchor-close" id="ac-gn-menuanchor-close">
              <span class="ac-gn-menuanchor-label">Global Nav Close Menu</span>
            </a>
          </li>
          <li class="ac-gn-item ac-gn-apple">
            <a class="ac-gn-link ac-gn-link-apple-developer" href="/" data-analytics-title="appledeveloper home" id="ac-gn-firstfocus-small">
              <span class="ac-gn-link-text">Apple Developer</span>
            </a>
          </li>
        </ul>
        <div class="ac-gn-search-placeholder-container" role="search">
          <div class="ac-gn-search ac-gn-search-small">
            <a id="ac-gn-link-search-small" class="ac-gn-link" href="/search/" data-analytics-title="search" data-analytics-click="search" data-analytics-intrapage-link aria-label="Search Developer">
              </a><div class="ac-gn-search-placeholder-bar">
                <div class="ac-gn-search-placeholder-input">
                  <div class="ac-gn-search-placeholder-input-text" aria-hidden="true">
                    <div class="ac-gn-link-search ac-gn-search-placeholder-input-icon"></div>
                    <span class="ac-gn-search-placeholder">Search Developer</span>
                  </div>
                </div>
                <div class="ac-gn-searchview-close ac-gn-searchview-close-small ac-gn-search-placeholder-searchview-close">
                  <span class="ac-gn-searchview-close-cancel" aria-hidden="true">Cancel</span>
                </div>
              </div>
            </a>
          </div>
        </div>
        <ul class="ac-gn-list">
          <li class="ac-gn-item ac-gn-apple">
            <a class="ac-gn-link ac-gn-link-apple-developer" href="/" data-analytics-title="appledeveloper home" id="ac-gn-firstfocus">
              <span class="ac-gn-link-text">Apple Developer</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-discover">
            <a class="ac-gn-link ac-gn-link-discover" href="/discover/" data-analytics-title="discover">
              <span class="ac-gn-link-text">Discover</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-design">
            <a class="ac-gn-link ac-gn-link-design" href="/design/" data-analytics-title="design">
              <span class="ac-gn-link-text">Design</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-develop">
            <a class="ac-gn-link ac-gn-link-develop" href="/develop/" data-analytics-title="develop">
              <span class="ac-gn-link-text">Develop</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-distribute">
            <a class="ac-gn-link ac-gn-link-distribute" href="/distribute/" data-analytics-title="distribute">
              <span class="ac-gn-link-text">Distribute</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-dsupport">
            <a class="ac-gn-link ac-gn-link-dsupport" href="/support/" data-analytics-title="dsupport">
              <span class="ac-gn-link-text">Support</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-account">
            <a class="ac-gn-link ac-gn-link-account" href="/account/" data-analytics-title="account">
              <span class="ac-gn-link-text">Account</span>
              </a>
          </li>
          <li class="ac-gn-item ac-gn-item-menu ac-gn-search" role="search">
            <a id="ac-gn-link-search" class="ac-gn-link ac-gn-link-search" href="/search/" data-analytics-title="search" data-analytics-click="search" data-analytics-intrapage-link aria-label="Search Developer"></a>
          </li>
        </ul>
        <aside id="ac-gn-searchview" class="ac-gn-searchview" role="search" data-analytics-region="search">
          <div class="ac-gn-searchview-content">
            <div class="ac-gn-searchview-bar">
              <div class="ac-gn-searchview-bar-wrapper">
                <form id="ac-gn-searchform" class="ac-gn-searchform" action="/search/" method="get">
                  <div class="ac-gn-searchform-wrapper">
                    <input id="ac-gn-searchform-input" class="ac-gn-searchform-input" type="text" name="q" aria-label="Search Developer" placeholder="Search Developer" autocorrect="off" autocapitalize="off" autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="true" aria-owns="quicklinks suggestions" />
                    <button id="ac-gn-searchform-submit" class="ac-gn-searchform-submit" type="submit" disabled aria-label="Submit Search"></button>
                    <button id="ac-gn-searchform-reset" class="ac-gn-searchform-reset" type="reset" disabled aria-label="Clear Search">
                        <span class="ac-gn-searchform-reset-background"></span>
                      </button>
                  </div>
                </form>
                <button id="ac-gn-searchview-close-small" class="ac-gn-searchview-close ac-gn-searchview-close-small" aria-label="Cancel Search">
                    <span class="ac-gn-searchview-close-cancel" aria-hidden="true">
                      Cancel
                    </span>
                  </button>
              </div>
            </div>
            <aside id="ac-gn-searchresults" class="ac-gn-searchresults" data-string-quicklinks="Quick Links" data-string-suggestions="Suggested Searches" data-string-noresults=""></aside>
          </div>
          <button id="ac-gn-searchview-close" class="ac-gn-searchview-close" aria-label="Cancel Search">
              <span class="ac-gn-searchview-close-wrapper">
                <span class="ac-gn-searchview-close-left"></span>
                <span class="ac-gn-searchview-close-right"></span>
              </span>
            </button>
        </aside>
          </div>
    </nav><div class="ac-gn-blur"></div><div id="ac-gn-curtain" class="ac-gn-curtain"></div><div id="ac-gn-placeholder" class="ac-nav-placeholder"></div><input type="checkbox" id="localnav-menustate" class="localnav-menustate" aria-hidden="true"/><nav id="localnav" class="localnav localnav-dark theme-dark localnav-scrim localnav-noborder" role="navigation" aria-label="API Reference" data-sticky="true"><div class="localnav-wrapper"><div class="referencenav"><div class="localnav-background"></div><div class="localnav-content"><a href="../../../index.html" class="localnav-title">Documentation</a><div class="localnav-menu"><a href="#localnav-menustate" id="localnav-menustate-open" class="localnav-menucta-anchor localnav-menucta-anchor-open"><span class="localnav-menucta-anchor-label" aria-hidden="true">Open Menu</span></a><a href="#" id="localnav-menustate-close" class="localnav-menucta-anchor localnav-menucta-anchor-close"><span class="localnav-menucta-anchor-label" aria-hidden="true">Close Menu</span></a><div class="localnav-menu-tray"><ul aria-label="Breadcrumbs" class="localnav-menu-items localnav-menu-breadcrumbs"><li class="localnav-menu-item localnav-menu-breadcrumb-item"><a class="localnav-menu-link" href="../../../documentation/foundation_language-objc.html"><span class="enstr">Foundation</span><!--end_enstr-->
<span class="jpstr">
ファウンデーション
</span><!--end_jpstr-->
</a></li><li class="localnav-menu-item localnav-menu-breadcrumb-item"><a class="localnav-menu-link" href="../../../documentation/foundation/url_loading_system_language-objc.html"><span class="enstr">URL Loading System</span><!--end_enstr-->
<span class="jpstr">
URLローディングシステム
</span><!--end_jpstr-->
</a></li><li class="localnav-menu-item localnav-menu-breadcrumb-item"><div class="localnav-menu-breadcrumb-current-container localnav-menu-link current"><span aria-current="page" class="localnav-menu-breadcrumb-current"><span class="enstr">Uploading Streams of Data</span><!--end_enstr-->
<span class="jpstr">
データのストリームをアップロードする
</span><!--end_jpstr-->
</span></div></li></ul><ul class="localnav-menu-items localnav-menu-settings" data-breadcrumbs-count="3"><li class="localnav-menu-setting language-container"><div class="language-toggle-container"><label for="language-toggle" class="language-toggle-label">Language:</label><select id="language-toggle" class="language-dropdown localnav-menu-link" style="width:auto"><option value="swift">Swift</option><option selected="" value="occ">Objective-C</option></select></div><div class="language-list-container"><span class="localnav-menu-setting-label">Language:</span><ul class="language-list"><li class="language-list-item"><a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data.html" class="localnav-menu-setting-link">Swift</a></li><li class="language-list-item"><span data-language="objc" aria-current="page" class="current-language">Objective-C</span></li></ul></div></li><li class="localnav-menu-setting"><span class="localnav-menu-setting-label">API Changes:</span><span class="changes-toggle">None</span></li></ul></div><div class="localnav-actions"><div class="localnav-action localnav-action-menucta" aria-hidden="true"><label for="localnav-menustate" class="localnav-menucta"><span class="localnav-menucta-chevron"></span></label></div></div></div></div></div></div></nav><label for="localnav-menustate" id="localnav-curtain" aria-hidden="true"></label><main role="main" id="main" class="main" tabindex="0"><div class="topic-title"><span class="eyebrow">Article</span><h1 class="topic-heading"><span><span class="enstr">Uploading Streams of Data</span><!--end_enstr-->
<span class="jpstr">
データのストリームをアップロードする
</span><!--end_jpstr-->
</span></h1></div><div class="topic-container section-content row"><div class="topic-description column large-9 medium-9 small-12"><div class="topic-abstract abstract formatted-content"><div><p><span class="enstr">Send a stream of data to a server.</span><!--end_enstr-->
<span class="jpstr">
データのストリームをサーバーに送信します。
</span><!--end_jpstr-->
</p></div></div></div><div class="topic-summary column large-3 medium-3 small-12"><div class="topic-summary-section frameworks" role="complementary" aria-label="Framework"><p class="topic-summary-section-label subsection-label"><span class="enstr">Framework</span><!--end_enstr-->
<span class="jpstr">
フレームワーク
</span><!--end_jpstr-->
</p><ul class="topic-summary-section-list"><li class="topic-summary-section-item"><span><span class="enstr">Foundation</span><!--end_enstr-->
<span class="jpstr">
ファウンデーション
</span><!--end_jpstr-->
</span></li></ul></div><div class="topic-summary-section onthispage"><nav class="onthispage-nav" aria-labelledby="onthispage-title"><p id="onthispage-title" class="topic-summary-section-label subsection-label"><span class="enstr">On This Page</span><!--end_enstr-->
<span class="jpstr">
この項には
</span><!--end_jpstr-->
</p><ul class="topic-summary-section-list"><li class="topic-summary-section-item"><a href="#overview" class="icon icon-after icon-chevrondowncircle"><span class="enstr">Overview</span><!--end_enstr-->
<span class="jpstr">
概要
</span><!--end_jpstr-->
</a></li><li class="topic-summary-section-item"><a href="#see-also" class="icon icon-after icon-chevrondowncircle"><span class="enstr">See Also</span><!--end_enstr-->
<span class="jpstr">
参照
</span><!--end_jpstr-->
</a></li></ul></nav></div></div><div class="topic-content column large-9 medium-9 small-12" id="topic-content"><section id="overview" class="section"><h2><span class="enstr">Overview</span><!--end_enstr-->
<span class="jpstr">
概要
</span><!--end_jpstr-->
</h2><div class="formatted-content"><div><p><span class="enstr">Streaming media apps and long-running apps that send continual updates use an ongoing stream to upload data, rather than sending a single block of data or a flat file.</span><!--end_enstr-->
<span class="jpstr">
ストリーミングメディアアプリと連続的なアップデートを送信する長く動作するアプリは、ある継続中のストリームを使ってデータをアップロードします、単一のブロックまたはフラットファイルを送信するのではなく。
</span><!--end_jpstr-->
You can configure an instance of <a class="symbol-name" href="../../../documentation/foundation/nsurlsessionuploadtask_language-objc.html"><code><span>NSURLSession<wbr/>Upload<wbr/>Task</span></code></a> (a subclass of <a class="symbol-name" href="../../../documentation/foundation/nsurlsessiontask_language-objc.html"><code><span>NSURLSession<wbr/>Task</span></code></a>) to work with a stream that you provide, and then fill this stream with data indefinitely.</p><p><span class="enstr">The task gets the stream by calling your session’s delegate, so you need to create a session and set your own code as its delegate.</span><!--end_enstr-->
<span class="jpstr">
タスクは、ストリームをあなたのセッションのもつ委任先を呼び出すことによって取得します、なのであなたはあるセッションを作成して、それの委任先としてあなた独自のコードを設定する必要があります。
</span><!--end_jpstr-->
</p></div><h3 id="3081174"><span class="enstr">Create a URL Session</span><!--end_enstr-->
<span class="jpstr">
URLセッションを作成する
</span><!--end_jpstr-->
</h3><div><p><span class="enstr">Begin by creating a URLSession and providing it with a delegate.</span><!--end_enstr-->
<span class="jpstr">
URLSessionを作成してそれにある委任先を提供することによって始めます。
</span><!--end_jpstr-->
<a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3081173">Listing 1</a> creates a URL session with the default <a class="symbol-name" href="../../../documentation/foundation/nsurlsessionconfiguration_language-objc.html"><code><span>NSURLSession<wbr/>Configuration</span></code></a> and sets <code class="code-voice"><span>self</span></code> as the delegate. You’ll implement <a class="symbol-name" href="../../../documentation/foundation/nsurlsessiontaskdelegate_language-objc.html"><code><span>NSURLSession<wbr/>Task<wbr/>Delegate</span></code></a> later, in <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037344">Provide the Stream to the Upload Task</a>.</p><figure id="3081173"><figcaption><strong class="caption-title"><span class="enstr">Listing 1</span><!--end_enstr-->
<span class="jpstr">
コード出力 1
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Creating a URLSession with a delegate</span><!--end_enstr-->
<span class="jpstr">
URLSessionをある委任先をつかって作成する
</span><!--end_jpstr-->
</p></div></div></figcaption><div class="formatted-content"><div class="code-listing"><pre class="code-source" data-language="swift"><code>lazy var session: URLSession = URLSession(configuration: .default,
                                          delegate: self,
                                          delegateQueue: .main)

</code></pre></div></div></figure><p></p><p></p><p></p><p></p></div><h3 id="3037348"><span class="enstr">Create a Streaming Upload Task</span><!--end_enstr-->
<span class="jpstr">
ストリーミングアップロードタスクを作成する
</span><!--end_jpstr-->
</h3><div><p>Create the upload task with the <a class="symbol-name" href="../../../documentation/foundation/nsurlsession_language-objc.html"><code><span>NSURLSession</span></code></a> method <a class="symbol-name" href="../../../documentation/foundation/nsurlsession/1410934-uploadtaskwithstreamedrequest_language-objc.html"><code><span>upload<wbr/>Task<wbr/>With<wbr/>Streamed<wbr/>Request:</span></code></a>. This takes an <a class="symbol-name" href="../../../documentation/foundation/nsurlrequest_language-objc.html"><code><span>NSURLRequest</span></code></a> specifying the URL you want to upload to, along with other parameters. You start the task by calling <a class="symbol-name" href="../../../documentation/foundation/nsurlsessiontask/1411121-resume_language-objc.html"><code><span>resume</span></code></a>. <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037347">Listing 2</a> shows how to create and start an upload task, connecting to a server on the local machine (<code class="code-voice"><span>127<wbr/>.0<wbr/>.0<wbr/>.1</span></code>) listening on port <code class="code-voice"><span>12345</span></code>.</p><figure id="3037347"><figcaption><strong class="caption-title"><span class="enstr">Listing 2</span><!--end_enstr-->
<span class="jpstr">
コード出力 2 
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Creating an upload task</span><!--end_enstr-->
<span class="jpstr">
アップロードタスクを作成する
</span><!--end_jpstr-->
</p></div></div></figcaption><div class="formatted-content"><div class="code-listing"><pre class="code-source" data-language="swift"><code>let url = URL(string: "http://127.0.0.1:12345")!
var request = URLRequest(url: url,
                         cachePolicy: .reloadIgnoringLocalCacheData,
                         timeoutInterval: 10)
request.httpMethod = "POST"
let uploadTask = session.uploadTask(withStreamedRequest: request)
uploadTask.resume()
</code></pre></div></div></figure><p></p></div><h3 id="3037352"><span class="enstr">Use a Bound Pair of Streams to Provide an Input Stream</span><!--end_enstr-->
<span class="jpstr">
ストリームの束縛対を使って入力ストリームを提供する
</span><!--end_jpstr-->
</h3><div><p>You provide the streaming data to the upload task as an <a class="symbol-name" href="../../../documentation/foundation/nsinputstream_language-objc.html"><code><span>NSInput<wbr/>Stream</span></code></a>. <span class="enstr">The task reads data from this stream and uploads it to the destination.</span><!--end_enstr-->
<span class="jpstr">
タスクは、データをこのストリームから読み出してそれを行き先にアップロードします。
</span><!--end_jpstr-->
</p><p><span class="enstr">A good way to provide data to the input stream is to use a <em>bound pair</em> of streams.</span><!--end_enstr-->
<span class="jpstr">
データを入力ストリームに提供する１つの良い方法は、ストリームの<em>束縛対</em>を使うことです。
</span><!--end_jpstr-->
The bound pair contains an <a class="symbol-name" href="../../../documentation/foundation/nsoutputstream_language-objc.html"><code><span>NSOutput<wbr/>Stream</span></code></a> that you write data to. <span class="enstr">Thanks to the binding of the streams, the data you write to the output stream is made available to the input stream, which the task can then read from. <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037791">Figure 1</a> shows this arrangement.</span><!--end_enstr-->
<span class="jpstr">
ストリームそれらの束縛に感謝しましょう、あなたが出力ストリームへと書き出すデータは、入力ストリームに利用できるようにされます、それはタスクがその時それから読み出せます。<a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037791">図 1</a> は、この取り決めを示します。
</span><!--end_jpstr-->
</p><figure id="3037791"><figcaption><strong class="caption-title"><span class="enstr">Figure 1</span><!--end_enstr-->
<span class="jpstr">
図 1
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Providing data to an upload task with a bound pair of streams</span><!--end_enstr-->
<span class="jpstr">
データをアップロードタスクにストリームの束縛対で提供する
</span><!--end_jpstr-->
</p></div></div></figcaption><img class="centered-block" src="../../../../docs-assets.developer.apple.com/published/da31e34bc2/a29fb2be-5f7f-4c56-9ef6-4090ecfbae82.png" srcSet="../../../../docs-assets.developer.apple.com/published/da31e34bc2/a29fb2be-5f7f-4c56-9ef6-4090ecfbae82.png 2x" alt="Flow diagram showing how data written by an app to the output stream of a bound pair goes into a buffer, then to the bound pair's input stream, then to the upload task, which sends it to the destination." width="613" height="auto"/></figure><p><a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037346">Listing 3</a> shows a structure called <code class="code-voice"><span>Streams</span></code> that consists of an <code class="code-voice"><span>NSInput<wbr/>Stream</span></code> and an <code class="code-voice"><span>NSOutput<wbr/>Stream</span></code>. The listing creates a property of this type, called <code class="code-voice"><span>bound<wbr/>Streams</span></code>, by calling the <a class="symbol-name" href="../../../documentation/foundation/nsstream/1412683-getboundstreamswithbuffersize_language-objc.html"><code><span>get<wbr/>Bound<wbr/>Streams<wbr/>With<wbr/>Buffer<wbr/>Size:<wbr/>input<wbr/>Stream:<wbr/>output<wbr/>Stream:</span></code></a> method of the <a class="symbol-name" href="../../../documentation/foundation/nsstream_language-objc.html"><code><span>NSStream</span></code></a> class, passing in in-out references for the input and output streams.</p><figure id="3037346"><figcaption><strong class="caption-title"><span class="enstr">Listing 3</span><!--end_enstr-->
<span class="jpstr">
コード出力 3 
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Creating a bound pair of input and output streams</span><!--end_enstr-->
<span class="jpstr">
入力および出力ストリームの束縛対を作成する
</span><!--end_jpstr-->
</p></div></div></figcaption><div class="formatted-content"><div class="code-listing"><pre class="code-source" data-language="swift"><code>struct Streams {
    let input: InputStream
    let output: OutputStream
}
lazy var boundStreams: Streams = {
    var inputOrNil: InputStream? = nil
    var outputOrNil: OutputStream? = nil
    Stream.getBoundStreams(withBufferSize: 4096,
                           inputStream: &amp;inputOrNil,
                           outputStream: &amp;outputOrNil)
    guard let input = inputOrNil, let output = outputOrNil else {
        fatalError("On return of `getBoundStreams`, both `inputStream` and `outputStream` will contain non-nil streams.")
    }
    // configure and open output stream
    output.delegate = self
    output.schedule(in: .current, forMode: .default)
    output.open()
    return Streams(input: input, output: output)
}()

</code></pre></div></div></figure><p><span class="enstr">When you create the bound pair, make sure you specify a buffer size large enough to hold any data you write to the output stream, prior to the data being read from the input stream. <span class="reference">Listing 3</span> uses a 4096-byte buffer.</span><!--end_enstr-->
<span class="jpstr">
あなたが束縛対を作成する場合、入力ストリームから読み出されるデータに先だって、あなたが出力ストリームに書き出す何らかのデータを保持するのに十分に大きいバッファサイズを指定することを確実にしてください。<span class="reference">コード出力 3</span> は、4096バイトのバッファを使います。
</span><!--end_jpstr-->
</p><p><span class="enstr">The listing also sets <code class="code-voice"><span>self</span></code> as the output stream’s delegate.</span><!--end_enstr-->
<span class="jpstr">
コード出力はまた、<code class="code-voice"><span>self</span></code>を出力ストリームのもつ委任先として設定します。
</span><!--end_jpstr-->
Declare that your class implements the <a class="symbol-name" href="../../../documentation/foundation/nsstreamdelegate_language-objc.html"><code><span>NSStream<wbr/>Delegate</span></code></a> protocol in order to receive events that indicate when the output stream is ready to receive new data. You’ll provide the implementation of <code class="code-voice"><span>NSStream<wbr/>Delegate</span></code> later, in <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037342">Write Data to the Stream When It’s Ready</a>.</p><aside class="aside aside-tip" aria-label="tip"><p class="aside-name"><span class="enstr">Tip</span><!--end_enstr-->
<span class="jpstr">
秘訣
</span><!--end_jpstr-->
</p><p>Your implementations of <code class="code-voice"><span>NSStream<wbr/>Delegate</span></code> and <code class="code-voice"><span>NSURLSession<wbr/>Task<wbr/>Delegate</span></code> may be in the same class or in different classes, whichever makes more sense for your app’s architecture.</p></aside><p></p></div><h3 id="3037344"><span class="enstr">Provide the Stream to the Upload Task</span><!--end_enstr-->
<span class="jpstr">
ストリームをアップロードタスクに提供する
</span><!--end_jpstr-->
</h3><div><p>You provide the input stream to the upload task in your implementation of the <code class="code-voice"><span>NSURLSession<wbr/>Task<wbr/>Delegate</span></code> method <code class="code-voice"><span>URLSession:<wbr/>task:<wbr/>need<wbr/>New<wbr/>Body<wbr/>Stream:</span></code>, which is called after you start the upload task by calling <code class="code-voice"><span>resume</span></code>. The callback passes in a completion handler, which you call directly, passing in the <code class="code-voice"><span>bound<wbr/>Streams<wbr/>.input</span></code> stream you created earlier. <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037340">Listing 4</a> shows an implementation of this method.</p><figure id="3037340"><figcaption><strong class="caption-title"><span class="enstr">Listing 4</span><!--end_enstr-->
<span class="jpstr">
コード出力 4 
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Providing the input stream to the upload task in the delegate callback</span><!--end_enstr-->
<span class="jpstr">
入力ストリームをアップロードタスクに委任先コールバックにおいて提供する
</span><!--end_jpstr-->
</p></div></div></figcaption><div class="formatted-content"><div class="code-listing"><pre class="code-source" data-language="swift"><code>func urlSession(_ session: URLSession, task: URLSessionTask,
                needNewBodyStream completionHandler: @escaping (InputStream?) -&gt; Void) {
    completionHandler(boundStreams.input)
}
</code></pre></div></div></figure><p></p><p></p></div><h3 id="3037342"><span class="enstr">Write Data to the Stream When It’s Ready</span><!--end_enstr-->
<span class="jpstr">
データをストリームにそれが準備できる時に書き出す
</span><!--end_jpstr-->
</h3><div><p><span class="enstr">Write data to an output stream only when the stream is ready for it.</span><!--end_enstr-->
<span class="jpstr">
データを出力ストリームに、ストリームがそれに対して準備できている時に限り書き出してください。
</span><!--end_jpstr-->
You get notified of the stream’s readiness in the <code class="code-voice"><span>NSStream<wbr/>Delegate</span></code> method <a class="symbol-name" href="../../../documentation/foundation/nsstreamdelegate/1410079-stream_language-objc.html"><code><span>stream:<wbr/>handle<wbr/>Event:</span></code></a>. When this callback sends <a class="symbol-name" href="../../../documentation/foundation/nsstreamevent/nsstreameventhasspaceavailable_language-objc.html"><code><span>NSStream<wbr/>Event<wbr/>Has<wbr/>Space<wbr/>Available</span></code></a> as its <code class="code-voice"><span>event<wbr/>Code</span></code> parameter, the stream is ready to accept more data.</p><p><span class="enstr">If you’re not ready to write while handling the event, and would prefer to write on your own schedule, you can set a flag variable and check it later to determine whether it’s is safe to write to the stream. <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037351">Listing 5</a> illustrates this technique.</span><!--end_enstr-->
<span class="jpstr">
あなたが書き出す準備ができていない一方でそのイベントを処理している、そしてあなた独自の予定で書き出すのを望むならば、あなたはあるフラグ変数を設定してそれを後で確認することで、ストリームに書き出すことが安全であるかどうかを決定できます。<a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037351">コード出力 5</a> は、このテクニックを例示します。
</span><!--end_jpstr-->
It handles the <a class="symbol-name" href="../../../documentation/foundation/nsstreamevent/nsstreameventhasspaceavailable_language-objc.html"><code><span>NSStream<wbr/>Event<wbr/>Has<wbr/>Space<wbr/>Available</span></code></a> event by just setting a private <code class="code-voice"><span>can<wbr/>Write</span></code> property to<code class="code-voice"><span> true.</span></code></p><p>While handling stream events, also check whether <code class="code-voice"><span>event<wbr/>Code</span></code> is <a class="symbol-name" href="../../../documentation/foundation/nsstreamevent/nsstreameventerroroccurred_language-objc.html"><code><span>NSStream<wbr/>Event<wbr/>Error<wbr/>Occurred</span></code></a>. <span class="enstr">This means that the stream has failed. When this happens, close the streams and abandon the upload.</span><!--end_enstr-->
<span class="jpstr">
これは、ストリームが失敗したことを意味します。これが起こる場合、ストリームを閉じてアップロードを放棄してください。
</span><!--end_jpstr-->
</p><figure id="3037351"><figcaption><strong class="caption-title"><span class="enstr">Listing 5</span><!--end_enstr-->
<span class="jpstr">
コード出力 5 
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Handling StreamDelegate events</span><!--end_enstr-->
<span class="jpstr">
StreamDelegateイベントを処理する
</span><!--end_jpstr-->
</p></div></div></figcaption><div class="formatted-content"><div class="code-listing"><pre class="code-source" data-language="swift"><code>func stream(_ aStream: Stream, handle eventCode: Stream.Event) {
    guard aStream == boundStreams.output else {
        return
    }
    if eventCode.contains(.hasSpaceAvailable) {
        canWrite = true
    }
    if eventCode.contains(.errorOccurred) {
        // Close the streams and alert the user that the upload failed.
    }
}

</code></pre></div></div></figure><p>Once you’re handling the <a class="symbol-name" href="../../../documentation/foundation/nsstreamevent/nsstreameventhasspaceavailable_language-objc.html"><code><span>NSStream<wbr/>Event<wbr/>Has<wbr/>Space<wbr/>Available</span></code></a> event, you can write to the stream whenever you know it’s ready to receive more data. You write to the stream by calling its <a class="symbol-name" href="../../../documentation/foundation/nsoutputstream/1410720-write_language-objc.html"><code><span>write:<wbr/>max<wbr/>Length:</span></code></a> method, providing a reference to the raw bytes to be written, and the maximum number of bytes to write.</p><p><span class="enstr"><a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037345">Listing 6</a> uses a timer to wait for the private <code class="code-voice"><span>can<wbr/>Write</span></code> property to become true. Once this is the case, the code creates a string representing the current date and converts it to raw bytes.</span><!--end_enstr-->
<span class="jpstr">
<a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037345">コード出力 6</a> は、あるタイマーを使うことで、プライベート<code class="code-voice"><span>can<wbr/>Write</span></code>プロパティがtrueになるのを待ちます。一旦そうなるならば、コードは現在のデータを表している文字列を作成して、それを生のバイトに変換します。
</span><!--end_jpstr-->
The listing then calls <a class="symbol-name" href="../../../documentation/foundation/nsoutputstream/1410720-write_language-objc.html"><code><span>write:<wbr/>max<wbr/>Length:</span></code></a> to send these bytes to the output stream. <span class="enstr">Because this output stream is bound to an input stream, the upload task can then automatically read these bytes from the input stream and send them to the destination URL.</span><!--end_enstr-->
<span class="jpstr">
この出力ストリームがある入力ストリームに束縛されることから、アップロードタスクはそのとき自動的にそれらバイトを入力ストリームから読み出せます、そしてそれらを行き先URLに送ります。
</span><!--end_jpstr-->
</p><figure id="3037345"><figcaption><strong class="caption-title"><span class="enstr">Listing 6</span><!--end_enstr-->
<span class="jpstr">
コード出力 6 
</span><!--end_jpstr-->
</strong> <div class="caption-content formatted-content"><div><p><span class="enstr">Creating a timer to write to the output stream when the stream has space available</span><!--end_enstr-->
<span class="jpstr">
あるタイマーを作成することで出力ストリームにそのストリームが利用可能な空間を持つ場合に書き出す
</span><!--end_jpstr-->
</p></div></div></figcaption><div class="formatted-content"><div class="code-listing"><pre class="code-source" data-language="swift"><code>timer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) {
    [weak self] timer in
    guard let self = self else { return }

    if self.canWrite {
        let message = "*** \(Date())\r\n"
        guard let messageData = message.data(using: .utf8) else { return }
        let messageCount = messageData.count
        let bytesWritten: Int = messageData.withUnsafeBytes() { (buffer: UnsafePointer&lt;UInt8&gt;) in
            self.canWrite = false
            return self.boundStreams.output.write(buffer, maxLength: messageCount)
        }
        if bytesWritten &lt; messageCount {
            // Handle writing less data than expected.
        }
    }
}

</code></pre></div></div></figure><aside class="aside aside-tip" aria-label="tip"><p class="aside-name"><span class="enstr">Tip</span><!--end_enstr-->
<span class="jpstr">
秘訣
</span><!--end_jpstr-->
</p><p><span class="enstr">If the data you want to stream is coming from an asynchronous process, like callbacks from a media capture device, you still have to wait for the output stream to be ready before you write to it. In these situations, you can use a circular buffer to hold your data until the stream is ready to accept it.</span><!--end_enstr-->
<span class="jpstr">
あなたがストリーミングしたいデータが非同期プロセスからやって来るならば、メディアキャプチャデバイスからのコールバックのように、あなたは依然として出力ストリームに対して待機することで、あなたがそれに書き出す前に準備できていなければなりません。これらの状況において、あなたはある循環バッファを使って、ストリームがそれを受け入れる準備ができるまであなたのデータを保持できます。
</span><!--end_jpstr-->
</p></aside><p>Once you write to the output stream, you can’t write again until your <code class="code-voice"><span>NSStream<wbr/>Delegate</span></code> receives a new <code class="code-voice"><span>NSStream<wbr/>Event<wbr/>Has<wbr/>Space<wbr/>Available</span></code> event. This example enforces this constraint by setting the class’ <code class="code-voice"><span>can<wbr/>Write</span></code> property to <code class="code-voice"><span>false</span></code>. It will be reset to <code class="code-voice"><span>true</span></code> when a new <code class="code-voice"><span>NSStream<wbr/>Event<wbr/>Has<wbr/>Space<wbr/>Available</span></code> event is received by the output stream's delegate, as shown earlier in <a href="../../../documentation/foundation/url_loading_system/uploading_streams_of_data_language-objc.html#3037351">Listing 5</a>.</p></div></div></section></div></div><section id="see-also" class="contenttable section alt-light-container row"><div class="alt-light"><div class="section-content"><h2 class="contenttable-title"><span class="enstr">See Also</span><!--end_enstr-->
<span class="jpstr">
参照
</span><!--end_jpstr-->
</h2><section id="3038363" class="contenttable-section"><div class="contenttable-container row"><div class="contenttable-section-title-container column large-3 medium-3 small-12"><h3 class="contenttable-section-title"><span class="enstr">Uploading</span><!--end_enstr-->
<span class="jpstr">
アップロード
</span><!--end_jpstr-->
</h3></div><div class="contenttable-section-content column large-9 medium-9 small-12"><div class="task-topics"><div class="task-topic"><div class="task-topic-info"><a class="has-adjacent-element symbol-name" href="../../../documentation/foundation/url_loading_system/uploading_data_to_a_website_language-objc.html"><svg xmlns="http://www.w3.org/2000/svg" height="15" viewBox="0 0 22 30" class="svg-icon symbol-name-icon" aria-hidden="true"><title>Article</title><g id="Article" class="svg-icon-small"><path d="M12.87,0H0V2H0V28H0v2H22V9.13ZM20,28H2V2h9V12h9Zm0-18H13V3l7,7Z"></path></g></svg><span><span class="enstr">Uploading Data to a Website</span><!--end_enstr-->
<span class="jpstr">
データをウェブサイトにアップロードする
</span><!--end_jpstr-->
</span></a><div class="task-topic-abstract task-topic-data abstract formatted-content"><div><p><span class="enstr">Post data from your app to servers.</span><!--end_enstr-->
<span class="jpstr">
データをあなたのアプリからサービスにポストします。
</span><!--end_jpstr-->
</p></div></div></div></div></div></div></div></section></div></div></section></main><section id="globalfooter-wrapper"><footer id="globalfooter" role="contentinfo">
        <nav class="footer-breadory">
          <a href="/" class="home breadcrumbs-home"><span aria-hidden="true"></span><span class="breadcrumbs-home-label">Developer</span></a>
          <section class="breadcrumbs">
            <ol class="breadcrumbs-list">
              <li><a href=/documentation>Documentation</a></li>
            </ol>
          </section>
          <div id="directorynav" class="directorynav">
            <div id="dn-cola" class="column">
              <h3><a href="/discover/">Discover</a></h3>
              <ul>
                <li><a href="/macos/">macOS</a></li>
                <li><a href="/ios/">iOS</a></li>
                <li><a href="/watchos/">watchOS</a></li>
                <li><a href="/tvos/">tvOS</a></li>
                <li><a href="/safari/">Safari and Web</a></li>
                <li><a href="/games/">Games</a></li>
                <li><a href="/business/">Business</a></li>
                <li><a href="/education/">Education</a></li>
                <li><a href="/wwdc/">WWDC</a></li>
              </ul>
            </div>
            <div id="dn-colb" class="column">
              <h3><a href="/design/">Design</a></h3>
              <ul>
                <li><a href="/design/human-interface-guidelines/">Human Interface Guidelines</a></li>
                <li><a href="/design/resources/"><span class="enstr">Resources</span><!--end_enstr-->
<span class="jpstr">
リソース
</span><!--end_jpstr-->
</a></li>
                <li><a href="/videos/design/">Videos</a></li>
                <li><a href="/design/awards/">Apple Design Awards</a></li>
                <li><a href="/accessibility/">Accessibility</a></li>
                <li><a href="/internationalization/"><span class="enstr">Internationalization</span><!--end_enstr-->
<span class="jpstr">
国際化
</span><!--end_jpstr-->
</a></li>
                <li><a href="/accessories/">Accessories</a></li>
              </ul>
            </div>
            <div id="dn-colc" class="column">
              <h3><a href="/develop/">Develop</a></h3>
              <ul>
                <li><a href="/xcode/">Xcode</a></li>
                <li><a href="/swift/">Swift</a></li>
                <li><a href="/swift-playgrounds/">Swift Playgrounds</a></li>
                <li><a href="/testflight/">TestFlight</a></li>
                <li><a href="https://developer.apple.com/documentation/">Documentation</a></li>
                <li><a href="/videos/">Videos</a></li>
                <li><a href="/download/">Downloads</a></li>
              </ul>
            </div>
            <div id="dn-cold" class="column">
              <h3><a href="/distribute/">Distribute</a></h3>
              <ul>
                <li><a href="/programs/">Developer Program</a></li>
                <li><a href="/app-store/">App Store</a></li>
                <li><a href="/app-store/review/">App Review</a></li>
                <li><a href="/macos/distribution/">Mac Software</a></li>
                <li><a href="/business/distribute/">Apps for Business</a></li>
                <li><a href="/safari/extensions/">Safari Extensions</a></li>
                <li><a href="/app-store/marketing/guidelines/">Marketing Resources</a></li>
                <li><a href="/softwarelicensing/">Trademark Licensing</a></li>
              </ul>
            </div>
            <div id="dn-cole" class="column">
              <h3><a href="/support/">Support</a></h3>
              <ul>
                <li><a href="https://forums.developer.apple.com">Developer Forums</a></li>
                <li><a href="/bug-reporting/">Bug Reporting</a></li>
                <li><a href="/terms/">License Agreements</a></li>
                <li><a href="/system-status/">System Status</a></li>
                <li><a href="/contact/">Contact Us</a></li>
              </ul>
              <h3><a href="/account/">Account</a></h3>
              <ul>
                <li><a href="/account/ios/certificate/">Certificates, IDs &amp; Profiles</a></li>
                <li><a href="https://appstoreconnect.apple.com/">App Store Connect</a></li>
              </ul>
            </div>
          </div>
        </nav>
        <div class="ac-gf-footer-legal">
          <div class="ac-gf-footer-news"> To receive the latest developer news, visit and subscribe to our <a href="/news/">News and Updates</a>.
          </div>
          <div class="ac-gf-footer-legal-copyright">Copyright © 2020 Apple Inc. All rights reserved.</div>
          <div class="ac-gf-footer-legal-links">
            <a href="https://www.apple.com/legal/internet-services/terms/site.html" class="first">Terms of Use</a>
            <a href="https://www.apple.com/privacy/privacy-policy/">Privacy Policy</a>
            <a href="/bug-reporting/">Report Bugs</a>
            <a href="/contact/submit/?subject=website-feedback">Feedback</a>
          </div>
          <div class="ac-gf-footer-language-links">
            <a href="/cn/" class="first">简体中文</a>
            <a href="/jp/">日本語</a>
            <a href="/kr/">한국어</a>
          </div>
        </div>
      </footer></section></div></div><script id="bootstrap-data" type="application/json">{"id":3037350,"title":{"content":"Uploading Streams of Data"},"abstract":"<div><p>Send a stream of data to a server.<\/p><\/div>","discussion":"<div><p>Streaming media apps and long-running apps that send continual updates use an ongoing stream to upload data, rather than sending a single block of data or a flat file. You can configure an instance of <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsessionuploadtask_language-objc\"><code><span>NSURLSession<wbr\/>Upload<wbr\/>Task<\/span><\/code><\/a> (a subclass of <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsessiontask_language-objc\"><code><span>NSURLSession<wbr\/>Task<\/span><\/code><\/a>) to work with a stream that you provide, and then fill this stream with data indefinitely.<\/p><p>The task gets the stream by calling your session’s delegate, so you need to create a session and set your own code as its delegate.<\/p><\/div><h3 id=\"3081174\">Create a URL Session<\/h3><div><p>Begin by creating a URLSession and providing it with a delegate. <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3081173\">Listing 1<\/a> creates a URL session with the default <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsessionconfiguration_language-objc\"><code><span>NSURLSession<wbr\/>Configuration<\/span><\/code><\/a> and sets <code class=\"code-voice\"><span>self<\/span><\/code> as the delegate. You’ll implement <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsessiontaskdelegate_language-objc\"><code><span>NSURLSession<wbr\/>Task<wbr\/>Delegate<\/span><\/code><\/a> later, in <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037344\">Provide the Stream to the Upload Task<\/a>.<\/p><figure id=\"3081173\"><figcaption><strong class=\"caption-title\">Listing 1<\/strong> <div class=\"caption-content formatted-content\"><div><p>Creating a URLSession with a delegate<\/p><\/div><\/div><\/figcaption><div class=\"formatted-content\"><div class=\"code-listing\"><pre class=\"code-source\" data-language=\"swift\"><code>lazy var session: URLSession = URLSession(configuration: .default,\n                                          delegate: self,\n                                          delegateQueue: .main)\n\n<\/code><\/pre><\/div><\/div><\/figure><p><\/p><p><\/p><p><\/p><p><\/p><\/div><h3 id=\"3037348\">Create a Streaming Upload Task<\/h3><div><p>Create the upload task with the <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsession_language-objc\"><code><span>NSURLSession<\/span><\/code><\/a> method <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsession\/1410934-uploadtaskwithstreamedrequest_language-objc\"><code><span>upload<wbr\/>Task<wbr\/>With<wbr\/>Streamed<wbr\/>Request:<\/span><\/code><\/a>. This takes an <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlrequest_language-objc\"><code><span>NSURLRequest<\/span><\/code><\/a> specifying the URL you want to upload to, along with other parameters. You start the task by calling <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsurlsessiontask\/1411121-resume_language-objc\"><code><span>resume<\/span><\/code><\/a>. <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037347\">Listing 2<\/a> shows how to create and start an upload task, connecting to a server on the local machine (<code class=\"code-voice\"><span>127<wbr\/>.0<wbr\/>.0<wbr\/>.1<\/span><\/code>) listening on port <code class=\"code-voice\"><span>12345<\/span><\/code>.<\/p><figure id=\"3037347\"><figcaption><strong class=\"caption-title\">Listing 2<\/strong> <div class=\"caption-content formatted-content\"><div><p>Creating an upload task<\/p><\/div><\/div><\/figcaption><div class=\"formatted-content\"><div class=\"code-listing\"><pre class=\"code-source\" data-language=\"swift\"><code>let url = URL(string: &quot;http:\/\/127.0.0.1:12345&quot;)!\nvar request = URLRequest(url: url,\n                         cachePolicy: .reloadIgnoringLocalCacheData,\n                         timeoutInterval: 10)\nrequest.httpMethod = &quot;POST&quot;\nlet uploadTask = session.uploadTask(withStreamedRequest: request)\nuploadTask.resume()\n<\/code><\/pre><\/div><\/div><\/figure><p><\/p><\/div><h3 id=\"3037352\">Use a Bound Pair of Streams to Provide an Input Stream<\/h3><div><p>You provide the streaming data to the upload task as an <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsinputstream_language-objc\"><code><span>NSInput<wbr\/>Stream<\/span><\/code><\/a>. The task reads data from this stream and uploads it to the destination.<\/p><p>A good way to provide data to the input stream is to use a <em>bound pair<\/em> of streams. The bound pair contains an <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsoutputstream_language-objc\"><code><span>NSOutput<wbr\/>Stream<\/span><\/code><\/a> that you write data to. Thanks to the binding of the streams, the data you write to the output stream is made available to the input stream, which the task can then read from. <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037791\">Figure 1<\/a> shows this arrangement.<\/p><figure id=\"3037791\"><figcaption><strong class=\"caption-title\">Figure 1<\/strong> <div class=\"caption-content formatted-content\"><div><p>Providing data to an upload task with a bound pair of streams<\/p><\/div><\/div><\/figcaption><img class=\"centered-block\" src=\"https:\/\/docs-assets.developer.apple.com\/published\/da31e34bc2\/a29fb2be-5f7f-4c56-9ef6-4090ecfbae82.png\" srcSet=\"https:\/\/docs-assets.developer.apple.com\/published\/da31e34bc2\/a29fb2be-5f7f-4c56-9ef6-4090ecfbae82.png 2x\" alt=\"Flow diagram showing how data written by an app to the output stream of a bound pair goes into a buffer, then to the bound pair&#x27;s input stream, then to the upload task, which sends it to the destination.\" width=\"613\" height=\"auto\"\/><\/figure><p><a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037346\">Listing 3<\/a> shows a structure called <code class=\"code-voice\"><span>Streams<\/span><\/code> that consists of an <code class=\"code-voice\"><span>NSInput<wbr\/>Stream<\/span><\/code> and an <code class=\"code-voice\"><span>NSOutput<wbr\/>Stream<\/span><\/code>. The listing creates a property of this type, called <code class=\"code-voice\"><span>bound<wbr\/>Streams<\/span><\/code>, by calling the <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstream\/1412683-getboundstreamswithbuffersize_language-objc\"><code><span>get<wbr\/>Bound<wbr\/>Streams<wbr\/>With<wbr\/>Buffer<wbr\/>Size:<wbr\/>input<wbr\/>Stream:<wbr\/>output<wbr\/>Stream:<\/span><\/code><\/a> method of the <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstream_language-objc\"><code><span>NSStream<\/span><\/code><\/a> class, passing in in-out references for the input and output streams.<\/p><figure id=\"3037346\"><figcaption><strong class=\"caption-title\">Listing 3<\/strong> <div class=\"caption-content formatted-content\"><div><p>Creating a bound pair of input and output streams<\/p><\/div><\/div><\/figcaption><div class=\"formatted-content\"><div class=\"code-listing\"><pre class=\"code-source\" data-language=\"swift\"><code>struct Streams {\n    let input: InputStream\n    let output: OutputStream\n}\nlazy var boundStreams: Streams = {\n    var inputOrNil: InputStream? = nil\n    var outputOrNil: OutputStream? = nil\n    Stream.getBoundStreams(withBufferSize: 4096,\n                           inputStream: &amp;inputOrNil,\n                           outputStream: &amp;outputOrNil)\n    guard let input = inputOrNil, let output = outputOrNil else {\n        fatalError(&quot;On return of `getBoundStreams`, both `inputStream` and `outputStream` will contain non-nil streams.&quot;)\n    }\n    \/\/ configure and open output stream\n    output.delegate = self\n    output.schedule(in: .current, forMode: .default)\n    output.open()\n    return Streams(input: input, output: output)\n}()\n\n<\/code><\/pre><\/div><\/div><\/figure><p>When you create the bound pair, make sure you specify a buffer size large enough to hold any data you write to the output stream, prior to the data being read from the input stream. <span class=\"reference\">Listing 3<\/span> uses a 4096-byte buffer.<\/p><p>The listing also sets <code class=\"code-voice\"><span>self<\/span><\/code> as the output stream’s delegate. Declare that your class implements the <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstreamdelegate_language-objc\"><code><span>NSStream<wbr\/>Delegate<\/span><\/code><\/a> protocol in order to receive events that indicate when the output stream is ready to receive new data. You’ll provide the implementation of <code class=\"code-voice\"><span>NSStream<wbr\/>Delegate<\/span><\/code> later, in <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037342\">Write Data to the Stream When It’s Ready<\/a>.<\/p><aside class=\"aside aside-tip\" aria-label=\"tip\"><p class=\"aside-name\">Tip<\/p><p>Your implementations of <code class=\"code-voice\"><span>NSStream<wbr\/>Delegate<\/span><\/code> and <code class=\"code-voice\"><span>NSURLSession<wbr\/>Task<wbr\/>Delegate<\/span><\/code> may be in the same class or in different classes, whichever makes more sense for your app’s architecture.<\/p><\/aside><p><\/p><\/div><h3 id=\"3037344\">Provide the Stream to the Upload Task<\/h3><div><p>You provide the input stream to the upload task in your implementation of the <code class=\"code-voice\"><span>NSURLSession<wbr\/>Task<wbr\/>Delegate<\/span><\/code> method <code class=\"code-voice\"><span>URLSession:<wbr\/>task:<wbr\/>need<wbr\/>New<wbr\/>Body<wbr\/>Stream:<\/span><\/code>, which is called after you start the upload task by calling <code class=\"code-voice\"><span>resume<\/span><\/code>. The callback passes in a completion handler, which you call directly, passing in the <code class=\"code-voice\"><span>bound<wbr\/>Streams<wbr\/>.input<\/span><\/code> stream you created earlier. <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037340\">Listing 4<\/a> shows an implementation of this method.<\/p><figure id=\"3037340\"><figcaption><strong class=\"caption-title\">Listing 4<\/strong> <div class=\"caption-content formatted-content\"><div><p>Providing the input stream to the upload task in the delegate callback<\/p><\/div><\/div><\/figcaption><div class=\"formatted-content\"><div class=\"code-listing\"><pre class=\"code-source\" data-language=\"swift\"><code>func urlSession(_ session: URLSession, task: URLSessionTask,\n                needNewBodyStream completionHandler: @escaping (InputStream?) -&gt; Void) {\n    completionHandler(boundStreams.input)\n}\n<\/code><\/pre><\/div><\/div><\/figure><p><\/p><p><\/p><\/div><h3 id=\"3037342\">Write Data to the Stream When It’s Ready<\/h3><div><p>Write data to an output stream only when the stream is ready for it. You get notified of the stream’s readiness in the <code class=\"code-voice\"><span>NSStream<wbr\/>Delegate<\/span><\/code> method <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstreamdelegate\/1410079-stream_language-objc\"><code><span>stream:<wbr\/>handle<wbr\/>Event:<\/span><\/code><\/a>. When this callback sends <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstreamevent\/nsstreameventhasspaceavailable_language-objc\"><code><span>NSStream<wbr\/>Event<wbr\/>Has<wbr\/>Space<wbr\/>Available<\/span><\/code><\/a> as its <code class=\"code-voice\"><span>event<wbr\/>Code<\/span><\/code> parameter, the stream is ready to accept more data.<\/p><p>If you’re not ready to write while handling the event, and would prefer to write on your own schedule, you can set a flag variable and check it later to determine whether it’s is safe to write to the stream. <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037351\">Listing 5<\/a> illustrates this technique. It handles the <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstreamevent\/nsstreameventhasspaceavailable_language-objc\"><code><span>NSStream<wbr\/>Event<wbr\/>Has<wbr\/>Space<wbr\/>Available<\/span><\/code><\/a> event by just setting a private <code class=\"code-voice\"><span>can<wbr\/>Write<\/span><\/code> property to<code class=\"code-voice\"><span> true.<\/span><\/code><\/p><p>While handling stream events, also check whether <code class=\"code-voice\"><span>event<wbr\/>Code<\/span><\/code> is <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstreamevent\/nsstreameventerroroccurred_language-objc\"><code><span>NSStream<wbr\/>Event<wbr\/>Error<wbr\/>Occurred<\/span><\/code><\/a>. This means that the stream has failed. When this happens, close the streams and abandon the upload.<\/p><figure id=\"3037351\"><figcaption><strong class=\"caption-title\">Listing 5<\/strong> <div class=\"caption-content formatted-content\"><div><p>Handling StreamDelegate events<\/p><\/div><\/div><\/figcaption><div class=\"formatted-content\"><div class=\"code-listing\"><pre class=\"code-source\" data-language=\"swift\"><code>func stream(_ aStream: Stream, handle eventCode: Stream.Event) {\n    guard aStream == boundStreams.output else {\n        return\n    }\n    if eventCode.contains(.hasSpaceAvailable) {\n        canWrite = true\n    }\n    if eventCode.contains(.errorOccurred) {\n        \/\/ Close the streams and alert the user that the upload failed.\n    }\n}\n\n<\/code><\/pre><\/div><\/div><\/figure><p>Once you’re handling the <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsstreamevent\/nsstreameventhasspaceavailable_language-objc\"><code><span>NSStream<wbr\/>Event<wbr\/>Has<wbr\/>Space<wbr\/>Available<\/span><\/code><\/a> event, you can write to the stream whenever you know it’s ready to receive more data. You write to the stream by calling its <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsoutputstream\/1410720-write_language-objc\"><code><span>write:<wbr\/>max<wbr\/>Length:<\/span><\/code><\/a> method, providing a reference to the raw bytes to be written, and the maximum number of bytes to write.<\/p><p><a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037345\">Listing 6<\/a> uses a timer to wait for the private <code class=\"code-voice\"><span>can<wbr\/>Write<\/span><\/code> property to become true. Once this is the case, the code creates a string representing the current date and converts it to raw bytes. The listing then calls <a class=\"symbol-name\" href=\"\/documentation\/foundation\/nsoutputstream\/1410720-write_language-objc\"><code><span>write:<wbr\/>max<wbr\/>Length:<\/span><\/code><\/a> to send these bytes to the output stream. Because this output stream is bound to an input stream, the upload task can then automatically read these bytes from the input stream and send them to the destination URL.<\/p><figure id=\"3037345\"><figcaption><strong class=\"caption-title\">Listing 6<\/strong> <div class=\"caption-content formatted-content\"><div><p>Creating a timer to write to the output stream when the stream has space available<\/p><\/div><\/div><\/figcaption><div class=\"formatted-content\"><div class=\"code-listing\"><pre class=\"code-source\" data-language=\"swift\"><code>timer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) {\n    [weak self] timer in\n    guard let self = self else { return }\n\n    if self.canWrite {\n        let message = &quot;*** \\(Date())\\r\\n&quot;\n        guard let messageData = message.data(using: .utf8) else { return }\n        let messageCount = messageData.count\n        let bytesWritten: Int = messageData.withUnsafeBytes() { (buffer: UnsafePointer&lt;UInt8&gt;) in\n            self.canWrite = false\n            return self.boundStreams.output.write(buffer, maxLength: messageCount)\n        }\n        if bytesWritten &lt; messageCount {\n            \/\/ Handle writing less data than expected.\n        }\n    }\n}\n\n<\/code><\/pre><\/div><\/div><\/figure><aside class=\"aside aside-tip\" aria-label=\"tip\"><p class=\"aside-name\">Tip<\/p><p>If the data you want to stream is coming from an asynchronous process, like callbacks from a media capture device, you still have to wait for the output stream to be ready before you write to it. In these situations, you can use a circular buffer to hold your data until the stream is ready to accept it.<\/p><\/aside><p>Once you write to the output stream, you can’t write again until your <code class=\"code-voice\"><span>NSStream<wbr\/>Delegate<\/span><\/code> receives a new <code class=\"code-voice\"><span>NSStream<wbr\/>Event<wbr\/>Has<wbr\/>Space<wbr\/>Available<\/span><\/code> event. This example enforces this constraint by setting the class’ <code class=\"code-voice\"><span>can<wbr\/>Write<\/span><\/code> property to <code class=\"code-voice\"><span>false<\/span><\/code>. It will be reset to <code class=\"code-voice\"><span>true<\/span><\/code> when a new <code class=\"code-voice\"><span>NSStream<wbr\/>Event<wbr\/>Has<wbr\/>Space<wbr\/>Available<\/span><\/code> event is received by the output stream&#x27;s delegate, as shown earlier in <a href=\"\/documentation\/foundation\/url_loading_system\/uploading_streams_of_data_language-objc#3037351\">Listing 5<\/a>.<\/p><\/div>","containingGroup":[{"id":3038363,"role":"task","paths":[],"symbols":[{"id":2919363,"role":"article","paths":["documentation\/foundation\/url_loading_system\/uploading_data_to_a_website"],"abstract":"<div><p>Post data from your app to servers.<\/p><\/div>","title":{"content":"Uploading Data to a Website"}},{"id":3037350,"role":"article","paths":["documentation\/foundation\/url_loading_system\/uploading_streams_of_data"],"abstract":"<div><p>Send a stream of data to a server.<\/p><\/div>","title":{"content":"Uploading Streams of Data"}}],"title":{"content":"Uploading"}}],"modules":[{"title":{"content":"Foundation"},"paths":["documentation\/foundation"],"importStatement":"<import xml:space=\"preserve\"><keyWord>@import<\/keyWord> Foundation<\/import>","availability":[{"platform":"iOS","introduced":"2.0"},{"platform":"tvOS","introduced":"9.0"},{"platform":"watchOS","introduced":"2.0"},{"platform":"Mac Catalyst","introduced":"13.0"},{"platform":"macOS","introduced":"10.0"}]}],"role":"article","language":"occ","roleHeading":"Article","languages":["occ","swift"],"variants":{"occ":{"paths":["documentation\/foundation\/url_loading_system\/uploading_streams_of_data"]},"swift":{"paths":["documentation\/foundation\/url_loading_system\/uploading_streams_of_data"]}},"pid":492525,"paths":["documentation\/foundation\/url_loading_system\/uploading_streams_of_data"],"hierarchy":[[{"id":1613013,"role":"collection","title":{"content":"Foundation"},"paths":["documentation\/foundation"]},{"id":2877756,"role":"collectionGroup","title":{"content":"URL Loading System"},"paths":["documentation\/foundation\/url_loading_system"]}]],"legalNotices":{"copyright":"Copyright &copy; 2020 Apple Inc. All rights reserved.","termsOfUse":"https:\/\/www.apple.com\/legal\/internet-services\/terms\/site.html","privacyPolicy":"https:\/\/www.apple.com\/privacy\/privacy-policy"}}</script></body></html>